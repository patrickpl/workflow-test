name: Signal Team Notifications

on:
  push:
    branches: [ "main", "master" ]
  issues:
    types: [opened, edited, labeled, unlabeled, assigned, unassigned, milestoned, demilestoned, closed, reopened]
  code_scanning_alert:
    types: [created, reopened, fixed]
  secret_scanning_alert:
    types: [created, resolved, reopened]
  # Uncomment and customize the workflow_run trigger below to monitor specific workflows
  # Note: workflow_run only works on the default branch (main/master)
  # Replace the workflow names with your actual workflow names
  # workflow_run:
  #   workflows: ["CI", "Tests", "Deploy"]  # List your workflow names here
  #   types: [completed]

jobs:
  signal-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Notification Data
        id: prep
        shell: bash
        run: |
          REPO_URL="https://github.com/${{ github.repository }}"

          if [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_SHA="${{ github.sha }}"
            SHORT_SHA="$(echo "$COMMIT_SHA" | cut -c1-7)"
            COMMIT_URL="$REPO_URL/commit/$COMMIT_SHA"

            echo "msg<<EOF" >> $GITHUB_OUTPUT
            echo "ðŸš€ New Commit!" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "ðŸ‘¤ Who: ${{ github.actor }}" >> $GITHUB_OUTPUT
            echo "ðŸ“ What: ${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
            echo "ðŸ”— Link: $COMMIT_URL ($SHORT_SHA)" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

          elif [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_URL="$REPO_URL/issues/${{ github.event.issue.number }}"

            if [ "${{ github.event.action }}" = "opened" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "ðŸ†• New Issue!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ“Œ Title: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
              echo "ðŸ‘¤ Von: ${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $ISSUE_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.action }}" = "closed" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "âœ… Issue Solved!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ“Œ Title: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
              echo "ðŸ‘¤ Solved by: ${{ github.event.sender.login }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $ISSUE_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Issue Updated!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ“Œ Title: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
              echo "ðŸ”§ Action: ${{ github.event.action }}" >> $GITHUB_OUTPUT
              echo "ðŸ‘¤ Updated by: ${{ github.event.sender.login }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $ISSUE_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi

          elif [ "${{ github.event_name }}" = "code_scanning_alert" ]; then
            ALERT_URL="$REPO_URL/security/code-scanning/${{ github.event.alert.number }}"

            if [ "${{ github.event.action }}" = "created" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "ðŸš¨ Security Alert: Code Scanning!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "âš ï¸ Severity: ${{ github.event.alert.rule.severity }}" >> $GITHUB_OUTPUT
              echo "ðŸ“ Rule: ${{ github.event.alert.rule.description }}" >> $GITHUB_OUTPUT
              echo "ðŸ“ File: ${{ github.event.alert.most_recent_instance.location.path }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $ALERT_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.action }}" = "reopened" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Security Alert Reopened!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "âš ï¸ Severity: ${{ github.event.alert.rule.severity }}" >> $GITHUB_OUTPUT
              echo "ðŸ“ Rule: ${{ github.event.alert.rule.description }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $ALERT_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.action }}" = "fixed" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "âœ… Security Alert Fixed!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ“ Rule: ${{ github.event.alert.rule.description }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $ALERT_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi

          elif [ "${{ github.event_name }}" = "secret_scanning_alert" ]; then
            ALERT_URL="$REPO_URL/security/secret-scanning/${{ github.event.alert.number }}"

            if [ "${{ github.event.action }}" = "created" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "ðŸ” Security Alert: Secret Detected!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ”‘ Secret Type: ${{ github.event.alert.secret_type }}" >> $GITHUB_OUTPUT
              echo "ðŸ“ Location: ${{ github.event.alert.secret }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $ALERT_URL" >> $GITHUB_OUTPUT
              echo "âš ï¸ Action Required: Review and revoke the exposed secret immediately!" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.action }}" = "resolved" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "âœ… Secret Alert Resolved!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ”‘ Secret Type: ${{ github.event.alert.secret_type }}" >> $GITHUB_OUTPUT
              echo "ðŸ‘¤ Resolved by: ${{ github.event.sender.login }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $ALERT_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.action }}" = "reopened" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Secret Alert Reopened!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ”‘ Secret Type: ${{ github.event.alert.secret_type }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $ALERT_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi

          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            WORKFLOW_URL="$REPO_URL/actions/runs/${{ github.event.workflow_run.id }}"
            WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
            CONCLUSION="${{ github.event.workflow_run.conclusion }}"

            if [ "$CONCLUSION" = "success" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "âœ… CI/CD Success!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Workflow: $WORKFLOW_NAME" >> $GITHUB_OUTPUT
              echo "ðŸ‘¤ Triggered by: ${{ github.event.workflow_run.triggering_actor.login }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $WORKFLOW_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            elif [ "$CONCLUSION" = "failure" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "âŒ CI/CD Failed!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Workflow: $WORKFLOW_NAME" >> $GITHUB_OUTPUT
              echo "ðŸ‘¤ Triggered by: ${{ github.event.workflow_run.triggering_actor.login }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $WORKFLOW_URL" >> $GITHUB_OUTPUT
              echo "âš ï¸ Action Required: Check the workflow logs for details" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            elif [ "$CONCLUSION" = "cancelled" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "ðŸš« CI/CD Cancelled!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Workflow: $WORKFLOW_NAME" >> $GITHUB_OUTPUT
              echo "ðŸ‘¤ Triggered by: ${{ github.event.workflow_run.triggering_actor.login }}" >> $GITHUB_OUTPUT
              echo "ðŸ”— Link: $WORKFLOW_URL" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi

          else
            echo "msg=Event type not supported: ${{ github.event_name }}" >> $GITHUB_OUTPUT
          fi

