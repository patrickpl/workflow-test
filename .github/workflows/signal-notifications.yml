name: Signal Team Notifications

on:
  push:
    branches: [ "main", "master" ]
  issues:
    types: [opened, edited, labeled, unlabeled, assigned, unassigned, milestoned, demilestoned, closed, reopened]

jobs:
  signal-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Notification Data
        id: prep
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "msg<<EOF" >> $GITHUB_OUTPUT
            echo "üöÄ New Commit!" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "üë§ Who: ${{ github.actor }}" >> $GITHUB_OUTPUT
            echo "üìù What: ${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
            echo "üîó Link: ${{ github.event.head_commit.url }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "issues" ]; then
            # Different notifications based on issue action
            if [ "${{ github.event.action }}" = "opened" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "üÜï New Issue!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "üìå Title: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
              echo "üë§ Von: ${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
              echo "üîó Link: ${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.action }}" = "closed" ]; then
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "‚úÖ Issue Solved!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "üìå Title: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
              echo "üë§ Solved by: ${{ github.event.sender.login }}" >> $GITHUB_OUTPUT
              echo "üîó Link: ${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              # For edited, labeled, assigned, milestoned, etc.
              echo "msg<<EOF" >> $GITHUB_OUTPUT
              echo "üîÑ Issue Updated!" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "üìå Title: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
              echo "üîß Action: ${{ github.event.action }}" >> $GITHUB_OUTPUT
              echo "üë§ Updated by: ${{ github.event.sender.login }}" >> $GITHUB_OUTPUT
              echo "üîó Link: ${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            echo "${{ github.event_name }}"
          fi

      - name: Send to Signal
        env:
          # Wir laden die Nachricht in eine Umgebungsvariable, um JSON-escaping Probleme zu vermeiden
          FINAL_MSG: ${{ steps.prep.outputs.msg }}
        run: |
          # jq ist auf GitHub-Runnern vorinstalliert und hilft uns, 
          # ein valides JSON zu bauen, selbst wenn der Commit-Text Anf√ºhrungszeichen enth√§lt.
          JSON_BODY=$(jq -n \
            --arg msg "$FINAL_MSG" \
            --arg num "${{ secrets.SIGNAL_SENDER_NUMBER }}" \
            --arg rec "${{ secrets.SIGNAL_GROUP_ID }}" \
            --arg img "${{ env.AVATAR_B64 }}" \
            '{
              message: $msg,
              number: $num,
              recipients: [$rec],
              base64_attachments: [$img],
              text_mode: "styled"
            }')

          curl -X POST "${{ secrets.SIGNAL_API_URL }}/v1/send" \
          -H "Content-Type: application/json" \
          -d "$JSON_BODY"
